name: release-pullrequest-kind-installer-chart-upgrade

on:
  pull_request:
    paths:
      - 'installer-chart/**'
      - '.github/workflows/release-pullrequest-kind-installer-chart-upgrade.yaml'
    branches:
      - main
  workflow_dispatch:

env:
  MODULE: installer
  GHCR_REPO: ghcr.io/${{ github.repository }}
  INSTALL_CRDS: "true"
  HAS_DEPLOYMENT: "true"

jobs:
  install-kind-and-upgrade:
    runs-on: ubuntu-latest
    strategy:
      matrix:
        k8s_version: [ "v1.32.8", "v1.33.4" ]

    steps:
      - name: Authenticate with GitHub App
        id: authenticate
        uses: tibdex/github-app-token@v1
        with:
          app_id: ${{ secrets.APP_ID }}
          private_key: ${{ secrets.PRIVATE_KEY }}

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Extract version
        run: |
          set -euo pipefail
          git fetch --tags --force

          echo "=== TAGS IN REPO (sorted) ==="
          git tag -l --sort=-version:refname | cat

          echo
          echo "=== Searching latest tags for module '${{ env.MODULE }}' ==="
          APP_VERSION="$(
            git tag -l '${{ env.MODULE }}/*' --sort=-version:refname \
            | head -n1 || true
          )"
          echo "Raw APP_VERSION tag: '${APP_VERSION}'"

          CHART_VERSION="$(
            git tag -l '${{ env.MODULE }}-chart/*' --sort=-version:refname \
            | head -n1 || true
          )"
          echo "Raw CHART_VERSION tag: '${CHART_VERSION}'"

          echo
          echo "=== Applying fallbacks if empty ==="
          APP_VERSION="${APP_VERSION:-${{ env.MODULE }}/0.0.1}"
          CHART_VERSION="${CHART_VERSION:-${{ env.MODULE }}-chart/0.0.1}"
          echo "After fallback → APP_VERSION='${APP_VERSION}'"
          echo "After fallback → CHART_VERSION='${CHART_VERSION}'"

          echo
          echo "=== Stripping prefix (keep only part after last '/') ==="
          APP_VERSION="${APP_VERSION##*/}"
          CHART_VERSION="${CHART_VERSION##*/}"
          echo "After strip → APP_VERSION='${APP_VERSION}'"
          echo "After strip → CHART_VERSION='${CHART_VERSION}'"

          {
            echo "APP_VERSION=$APP_VERSION"
            echo "CHART_VERSION=$CHART_VERSION"
          } >> "$GITHUB_ENV"

      - name: Echo
        run: |
          echo "APP_VERSION=${{ env.APP_VERSION }}"
          echo "CHART_VERSION=${{ env.CHART_VERSION }}"

      - name: Replace CHART_VERSION in ./${{ env.MODULE }}-chart/Chart.yaml
        run: sed -i 's/CHART_VERSION/${{ env.CHART_VERSION }}/g' ./${{ env.MODULE }}-chart/Chart.yaml

      - name: Replace APP_VERSION in ./${{ env.MODULE }}-chart/Chart.yaml
        run: sed -i 's/APP_VERSION/${{ env.APP_VERSION }}/g' ./${{ env.MODULE }}-chart/Chart.yaml

      - name: Set up Helm
        uses: azure/setup-helm@v4.1.0

      - name: Helm lint chart
        run: helm lint ./${{ env.MODULE }}-chart

      - name: Create k8s Kind Cluster
        uses: helm/kind-action@v1
        with:
          node_image: kindest/node:${{ matrix.k8s_version }}

      - name: Install ${{ env.MODULE }}-crd chart
        if: env.INSTALL_CRDS == 'true'
        run: |
          helm repo add krateo https://charts.krateo.io
          helm repo update krateo
          helm install ${{ env.MODULE }}-crd krateo/${{ env.MODULE }}-crd --create-namespace -n krateo-system --wait --timeout=120s

      - name: Install ${{ env.MODULE }} previous chart
        run: |
          helm install ${{ env.MODULE }} krateo/${{ env.MODULE }} --create-namespace -n krateo-system --wait
          helm list -n krateo-system

      - name: Wait for ${{ env.MODULE }} deployment of previous chart to become Available
        if: env.HAS_DEPLOYMENT == 'true'
        run: kubectl wait deployment ${{ env.MODULE }} --for condition=Available=True --timeout=120s --namespace krateo-system

      - name: Install ${{ env.MODULE }} chart
        run: |
          helm upgrade ${{ env.MODULE }} ./${{ env.MODULE }}-chart --create-namespace -n krateo-system --wait

      - name: Wait for ${{ env.MODULE }} deployment to become Available
        if: env.HAS_DEPLOYMENT == 'true'
        run: kubectl wait deployment ${{ env.MODULE }} --for condition=Available=True --timeout=120s --namespace krateo-system

      - name: Helm list -A
        if: always()
        run: helm list -A

      - name: Get deployments -A
        if: always()
        run: kubectl get deployments -A

      - name: Get events -A
        if: always()
        run: kubectl get events -A --sort-by='.lastTimestamp'